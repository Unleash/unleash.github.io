"use strict";(self.webpackChunkwebsitev_2=self.webpackChunkwebsitev_2||[]).push([[86587],{69446:(e,t,i)=>{i.r(t),i.d(t,{assets:()=>l,contentTitle:()=>s,default:()=>u,frontMatter:()=>r,metadata:()=>o,toc:()=>d});var a=i(87462),n=(i(67294),i(3905));const r={title:"ADR: Breaking DB changes"},s=void 0,o={unversionedId:"contributing/ADRs/back-end/breaking-db-changes",id:"contributing/ADRs/back-end/breaking-db-changes",title:"ADR: Breaking DB changes",description:"Background",source:"@site/docs/contributing/ADRs/back-end/breaking-db-changes.md",sourceDirName:"contributing/ADRs/back-end",slug:"/contributing/ADRs/back-end/breaking-db-changes",permalink:"/contributing/ADRs/back-end/breaking-db-changes",draft:!1,editUrl:"https://github.com/Unleash/unleash/edit/main/website/docs/contributing/ADRs/back-end/breaking-db-changes.md",tags:[],version:"current",frontMatter:{title:"ADR: Breaking DB changes"},sidebar:"documentation",previous:{title:"ADR: POST/PUT API payload",permalink:"/contributing/ADRs/back-end/POST-PUT-api-payload"},next:{title:"ADR: Naming",permalink:"/contributing/ADRs/back-end/naming"}},l={},d=[{value:"Background",id:"background",level:2},{value:"Decision",id:"decision",level:2},{value:"Avoid Breaking DB Changes",id:"avoid-breaking-db-changes",level:3},{value:"Use the &quot;Expand/Contract&quot; Pattern",id:"use-the-expandcontract-pattern",level:3},{value:"Expand Phase",id:"expand-phase",level:4},{value:"Contract Phase",id:"contract-phase",level:4},{value:"Code Reviewer Responsibilities",id:"code-reviewer-responsibilities",level:3},{value:"Separate Migrations as Distinct PRs",id:"separate-migrations-as-distinct-prs",level:3},{value:"Primary Key Requirement for New Tables",id:"primary-key-requirement-for-new-tables",level:3}],c={toc:d};function u(e){let{components:t,...i}=e;return(0,n.kt)("wrapper",(0,a.Z)({},c,i,{components:t,mdxType:"MDXLayout"}),(0,n.kt)("h2",{id:"background"},"Background"),(0,n.kt)("p",null,"During the evolution of a feature different clients may use different version of code e.g. behind a feature flag.\nIf the code relies on breaking DB changes (column delete, table rename, deleting DB entries etc.) it may lead to errors."),(0,n.kt)("p",null,"The very same problem occurs when you apply a breaking migration just before the new version of the application starts e.g. during a zero-downtime deployment (whatever strategy you use).\nThe code is still running against the old schema as the migration takes a few seconds to apply."),(0,n.kt)("h2",{id:"decision"},"Decision"),(0,n.kt)("p",null,"To address these challenges, follow these guidelines:"),(0,n.kt)("h3",{id:"avoid-breaking-db-changes"},"Avoid Breaking DB Changes"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("strong",{parentName:"li"},"Prioritize avoiding breaking changes")," in the DB schema whenever possible.")),(0,n.kt)("h3",{id:"use-the-expandcontract-pattern"},'Use the "Expand/Contract" Pattern'),(0,n.kt)("p",null,'If breaking changes are inevitable, use the "expand/contract" pattern:'),(0,n.kt)("h4",{id:"expand-phase"},"Expand Phase"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("strong",{parentName:"li"},"Maintain both old and new DB schemas")," in parallel."),(0,n.kt)("li",{parentName:"ul"},"Ensure ",(0,n.kt)("strong",{parentName:"li"},"code compatibility with both schemas"),"."),(0,n.kt)("li",{parentName:"ul"},"Keep dual compatibility for ",(0,n.kt)("strong",{parentName:"li"},"at least 2 minor releases"),", allowing client upgrades."),(0,n.kt)("li",{parentName:"ul"},"This approach also supports ",(0,n.kt)("strong",{parentName:"li"},"downgrading within this version range")," without reverting migrations.")),(0,n.kt)("h4",{id:"contract-phase"},"Contract Phase"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("strong",{parentName:"li"},"Remove the old DB schema")," once no clients use the old version.")),(0,n.kt)("h3",{id:"code-reviewer-responsibilities"},"Code Reviewer Responsibilities"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("strong",{parentName:"li"},"Action for a Code Reviewer:")," When you spot a migration with ",(0,n.kt)("inlineCode",{parentName:"li"},"ALTER TABLE DROP COLUMN")," or ",(0,n.kt)("inlineCode",{parentName:"li"},"ALTER TABLE RENAME TO"),', please raise a flag if the "expand phase" was missed.')),(0,n.kt)("h3",{id:"separate-migrations-as-distinct-prs"},"Separate Migrations as Distinct PRs"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"Carry out all migrations in ",(0,n.kt)("strong",{parentName:"li"},"separate pull requests (PRs)")," and closely monitor them during deployment. Monitoring should be performed using Grafana, observing any failing requests or errors in the logs.")),(0,n.kt)("h3",{id:"primary-key-requirement-for-new-tables"},"Primary Key Requirement for New Tables"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"All new tables must have a primary key to ensure data integrity, improve query efficiency, and establish foreign key relationships. Primary keys also address migration issues in replicated databases without PostgreSQL replica identities. Exceptions require strong justification.")),(0,n.kt)("p",null,"Following these guidelines reduces the risk of errors and compatibility issues during DB schema changes, enhancing stability and reliability in software development."))}u.isMDXComponent=!0}}]);